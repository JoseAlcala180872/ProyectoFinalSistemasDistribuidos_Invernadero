<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Invernadero - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="asstets/css/dashboard-estilos.css">

</head>
<body>
    <!-- Barra lateral -->
    <nav class="sidebar">
        <div class="sidebar-icon active" title="Dashboard">
            <i class="fas fa-home"></i>
        </div>
        <div class="sidebar-icon" title="Sensores">
            <i class="fas fa-plus"></i>
        </div>
        <div class="sidebar-icon" title="Notificaciones">
            <i class="fas fa-bell"></i>
        </div>
        <div class="sidebar-icon" title="Estadísticas">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="sidebar-icon" title="Configuración">
            <i class="fas fa-cog"></i>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="main-content">
        <div class="navbar">
            <h1>Control de invernadero</h1>
            <div class="user-info">
                <div class="weather-info">
                    <i class="fas fa-cloud-sun weather-icon"></i>
                    <span>Exterior: 18°C</span>
                </div>
                <div class="user-avatar">AG</div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-temperature-high"></i></div>
                <div class="stat-title">Temperatura actual</div>
                <div class="stat-value">9°</div>
                <div class="stat-time">9:00 AM</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-tint"></i></div>
                <div class="stat-title">Humedad actual</div>
                <div class="stat-value">10%</div>
                <div class="stat-note">The dew point is 27° right now</div>
            </div>
        </div>
        
        <div class="history-card">
            <div class="history-title">Datos históricos de temperatura</div>
            <div class="history-subtitle">En la última temporada</div>
            <div class="chart-container">
                <div class="chart-grid">
                    <div class="grid-line"></div>
                    <div class="grid-line"></div>
                    <div class="grid-line"></div>
                </div>
                <div class="data-graph"></div>
            </div>
        </div>
        
        <div class="hourly-charts">
            <div class="hourly-chart">
                <h2>Temperatura por hora</h2>
                <div class="chart-hourly">
                    <div class="hourly-grid">
                        <div class="hourly-grid-line"></div>
                        <div class="hourly-grid-line"></div>
                        <div class="hourly-grid-line"></div>
                    </div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                </div>
                <div class="time-markers">
                    <span class="time-marker">10AM</span>
                    <span class="time-marker">11AM</span>
                    <span class="time-marker">12AM</span>
                    <span class="time-marker">01PM</span>
                    <span class="time-marker">02PM</span>
                    <span class="time-marker">03PM</span>
                </div>
            </div>
            
            <div class="hourly-chart">
                <h2>Humedad por hora</h2>
                <div class="chart-hourly">
                    <div class="hourly-grid">
                        <div class="hourly-grid-line"></div>
                        <div class="hourly-grid-line"></div>
                        <div class="hourly-grid-line"></div>
                    </div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                    <div class="data-point"></div>
                </div>
                <div class="time-markers">
                    <span class="time-marker">10AM</span>
                    <span class="time-marker">11AM</span>
                    <span class="time-marker">12AM</span>
                    <span class="time-marker">01PM</span>
                    <span class="time-marker">02PM</span>
                    <span class="time-marker">03PM</span>
                </div>
            </div>
        </div>
        
        <div class="nav-links">
            <a href="sensores.html" class="nav-link">Ver Sensores</a>
            <a href="alarmas.html" class="nav-link">Ver Alarmas</a>
            <a href="datosFecha.html" class="nav-link">Ver Datos</a>
        </div>
    </div>

    <script type="module">
        import { obtenerUltimosDatos } from './servicios/datosServicio.js';
        import { obtenerDatosPorHora } from './servicios/datosPorHoraServicio.js';
        // Actualiza los valores de temperatura y humedad en el dashboard
        async function actualizarDashboard() {
            try {
                const datos = await obtenerUltimosDatos();
                if (datos && datos.length > 0) {
                    const ultimo = datos[datos.length - 1];
                    // Cambia ambos valores cada vez
                    document.querySelectorAll('.stat-card .stat-value')[0].textContent = `${ultimo.temperatura}°`;
                    document.querySelectorAll('.stat-card .stat-value')[1].textContent = `${ultimo.humedad}%`;
                    document.querySelector('.stat-time').textContent = new Date(ultimo.fechaHora).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            } catch (error) {
                console.error('Error al actualizar dashboard:', error);
            }
        }
        async function actualizarGraficasPorHora() {
            try {
                const datos = await obtenerDatosPorHora();
                // Horas que se muestran en la gráfica (ajusta según tus labels)
                const horas = [10, 11, 12, 13, 14, 15];
                const tempChart = document.querySelectorAll('.hourly-chart')[0].querySelectorAll('.data-point');
                const humChart = document.querySelectorAll('.hourly-chart')[1].querySelectorAll('.data-point');
                // Escala máxima para la gráfica
                const maxTemp = 50; // Máxima temperatura esperada
                const maxHum = 100; // Máxima humedad esperada

                horas.forEach((hora, idx) => {
                    const dato = datos.find(d => d._id === hora);
                    if (dato) {
                        // Calcula el porcentaje invertido (0% arriba, 100% abajo)
                        const tempPercent = 100 - (dato.promedioTemperatura / maxTemp) * 100;
                        const humPercent = 100 - (dato.promedioHumedad / maxHum) * 100;
                        tempChart[idx].style.top = `${tempPercent}%`;
                        tempChart[idx].title = `${dato.promedioTemperatura.toFixed(1)}°C`;
                        humChart[idx].style.top = `${humPercent}%`;
                        humChart[idx].title = `${dato.promedioHumedad.toFixed(1)}%`;
                    } else {
                        tempChart[idx].style.top = '100%';
                        tempChart[idx].title = 'Sin datos';
                        humChart[idx].style.top = '100%';
                        humChart[idx].title = 'Sin datos';
                    }
                });
            } catch (error) {
                console.error('Error al actualizar gráficas por hora:', error);
            }
        }
        actualizarDashboard();
        actualizarGraficasPorHora();
        setInterval(() => {
            actualizarDashboard();
            actualizarGraficasPorHora();
        }, 5000);
    </script>
</body>
</html>